{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-white">Dashboard</h1>
            <p class="text-gray-400 mt-1">{{ today.strftime('%B %d, %Y') }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('attendance_page') }}" class="glass px-4 py-2 rounded-lg text-blue-400 hover:text-blue-300 transition-colors">
                View Attendance
            </a>
            <a href="{{ url_for('export_daily') }}" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-white transition-colors">
                Export Today
            </a>
        </div>
    </div>


    </div>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Users -->
        <div class="glass rounded-lg p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Total Users</p>
                    <p class="text-3xl font-bold text-white mt-2">{{ metrics.total_users }}</p>
                </div>
                <div class="h-12 w-12 bg-blue-900/50 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Present Today -->
        <div class="glass rounded-lg p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Present Today</p>
                    <p class="text-3xl font-bold text-green-400 mt-2">{{ metrics.present_today }}</p>
                    <p class="text-xs text-gray-500 mt-1">{{ metrics.attendance_rate }}% attendance</p>
                </div>
                <div class="h-12 w-12 bg-green-900/50 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Absent Today -->
        <div class="glass rounded-lg p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Absent Today</p>
                    <p class="text-3xl font-bold text-red-400 mt-2">{{ metrics.absent_today }}</p>
                </div>
                <div class="h-12 w-12 bg-red-900/50 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Late Today -->
        <div class="glass rounded-lg p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Late Today</p>
                    <p class="text-3xl font-bold text-yellow-400 mt-2">{{ metrics.late_today }}</p>
                </div>
                <div class="h-12 w-12 bg-yellow-900/50 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Camera Feed -->
    {% if enable_stream %}
    <div class="glass rounded-lg p-6">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
            <span class="h-2 w-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
            Live Camera Feed
        </h2>
        <div class="relative rounded-lg overflow-hidden bg-black">
            <img src="{{ url_for('video_feed') }}" alt="Live Feed" class="w-full h-auto">
            <div class="absolute top-4 right-4 glass px-3 py-1 rounded-lg">
                <span class="text-green-400 text-sm font-medium">● LIVE</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Late Employees -->
        <div class="glass rounded-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">Late Arrivals Today</h2>
            {% if metrics.late_employees %}
            <div class="space-y-3">
                {% for emp in metrics.late_employees %}
                <div class="bg-yellow-900/20 border border-yellow-700/30 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-white font-medium">{{ emp.name }}</span>
                        <span class="text-yellow-400 text-sm">{{ emp.time }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-400 text-center py-8">No late arrivals today</p>
            {% endif %}
        </div>

        <!-- Absent Employees -->
        <div class="glass rounded-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">Absent Today</h2>
            {% if metrics.absent_employees %}
            <div class="space-y-3">
                {% for emp in metrics.absent_employees %}
                <div class="bg-red-900/20 border border-red-700/30 rounded-lg p-3">
                    <span class="text-white font-medium">{{ emp.name }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-400 text-center py-8">Everyone is present!</p>
            {% endif %}
        </div>
    </div>

    <!-- Weekly Trend Chart -->
    {% if metrics.weekly_labels %}
    <div class="glass rounded-lg p-6">
        <h2 class="text-xl font-bold text-white mb-4">Weekly Attendance Trend</h2>
        <canvas id="weeklyChart" height="80"></canvas>
    </div>
    {% endif %}
</div>

<!-- Real-Time Notification Toast -->
<div id="scanNotification" class="fixed top-24 right-4 z-50 hidden">
    <div class="glass rounded-lg shadow-2xl p-4 border-l-4 border-green-500 min-w-[300px] animate-slide-in">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm font-medium text-white" id="scanNotificationTitle">User Scanned In</p>
                <p class="text-sm text-gray-400 mt-1" id="scanNotificationMessage">Details loading...</p>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes slide-in {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.animate-slide-in {
    animation: slide-in 0.3s ease;
}
</style>

<script>
// Real-Time Monitoring
let lastScanName = '';
let lastScanTime = '';

async function checkForNewScans() {
    try {
        const response = await fetch('/api/engine_status');
        const data = await response.json();
        
        if (data.ok && data.name) {
            // Update live status banner
            const banner = document.getElementById('liveStatusBanner');
            const nameEl = document.getElementById('liveStatusName');
            const detailsEl = document.getElementById('liveStatusDetails');
            
            banner.classList.remove('hidden');
            nameEl.textContent = `${data.name} at Gate ${data.gate || '?'}`;
            
            if (data.distance !== null && data.confidence !== null) {
                detailsEl.textContent = `Confidence: ${(data.confidence * 100).toFixed(0)}% | Quality: ${data.quality?.toFixed(0) || '?'}%`;
            }
            
            // Show notification for NEW scans only
            const scanKey = `${data.name}-${data.gate}-${data.ts}`;
            if (scanKey !== lastScanTime) {
                lastScanTime = scanKey;
                showScanNotification(data.name, data.gate, data.confidence);
                
                // Reload metrics after 2 seconds to update counts
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }
    } catch (error) {
        console.error('Error checking engine status:', error);
    }
}

function showScanNotification(name, gate, confidence) {
    const notification = document.getElementById('scanNotification');
    const title = document.getElementById('scanNotificationTitle');
    const message = document.getElementById('scanNotificationMessage');
    
    title.textContent = `✓ ${name} Checked In`;
    message.textContent = `Gate ${gate} • ${new Date().toLocaleTimeString()}`;
    
    notification.classList.remove('hidden');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 5000);
    
    // Play notification sound (optional)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSmJ0fPTgjMGHm7A7+OZSA0PVqzn77BdGAk+ltryxmwhBSaO1PLSgTYHG2vA7uGcSw0NUKjl8bNfGwlAnN3yvH0iByJ+z/Lahz0KE17A7OihUhQJQJzi8sFuIwYkjM/z1IU5BxlrwO7hmEcODlKu5O+zXRsIQZ3c87h7JAgefM/z2Ic9ChFew+3qoFMUCkSc4PKkdhsHKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSmJ0fPTgjMGHm7A7+OZSA0PVqzn77BdGAk+ltryxmwhBSaO1PLSgTYHG2vA7uGcSw0NUKjl8bNfGwlAnN3yvH0iByJ+z/Lahz0KE17A7OihUhQJQJzi8sFuIwYkjM/z1IU5BxlrwO7hmEcODlKu5O+zXRsIQZ3c87h7JAgefM/z2Ic9ChFew+3qoFMUCkSc4PKkdhsHKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSmJ0fPTgjMGHm7A7+OZSA0PVqzn77BdGAk+ltryxmwhBSaO1PLSgTYHG2vA7uGcSw0NUKjl8bNfGwlAnN3yvH0iByJ+z/Lahz0KE17A7OihUhQJQJzi8sFuIwYkjM/z1IU5BxlrwO7hmEcODlKu5O+zXRsIQZ3c87h7JAgefM/z2Ic9ChFew+3qoFMUCkSc4PKkdhsHKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSmJ0fPTgjMGHm7A7+OZSA0PVqzn77BdGAk+ltryxmwhBSaO1PLSgTYHG2vA7uGcSw0NUKjl8bNfGwlAnN3yvH0iByJ+z/Lahz0KE17A7OihUhQJQJzi8sFuIwYkjM/z1IU5BxlrwO7hmEcODlKu5O+zXRsIQZ3c87h7JAgefM/z2Ic9ChFew+3qoFMUCkSc4PKkdhsHKIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBg==');
        audio.volume = 0.3;
        audio.play().catch(() => {}); // Ignore errors if autoplay is blocked
    } catch (e) {}
}

function closeLiveBanner() {
    document.getElementById('liveStatusBanner').classList.add('hidden');
}

// Poll every 2 seconds for new scans
setInterval(checkForNewScans, 2000);

// Start checking immediately
checkForNewScans();

// Weekly Chart
{% if metrics.weekly_labels %}
const ctx = document.getElementById('weeklyChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ metrics.weekly_labels | tojson }},
        datasets: [
            {
                label: 'Present',
                data: {{ metrics.weekly_present | tojson }},
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            },
            {
                label: 'Late',
                data: {{ metrics.weekly_late | tojson }},
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                labels: { color: '#9ca3af' }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
        }
    }
});
{% endif %}
</script>

{% endblock %}