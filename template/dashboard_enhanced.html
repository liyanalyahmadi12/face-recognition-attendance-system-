{% extends "base.html" %}

{% block extra_css %}
<style>
  /* ===== Cinematic Reel (kept here if you want to use later) ===== */
  .reel-wrap{ --h:180px; --gap:16px; --speed:40s; mask-image:radial-gradient(90% 100% at 50% 50%, #000 60%, transparent 100%); }
  .reel-viewport{ height:var(--h); border-radius:1.25rem; overflow:hidden; position:relative; }
  .reel-gradient{ position:absolute; inset:0; background:linear-gradient(90deg, rgba(11,18,32,0.9) 0%, transparent 15%, transparent 85%, rgba(11,18,32,0.9) 100%); pointer-events:none; }
  .reel-track{ display:flex; align-items:center; gap:var(--gap); position:absolute; inset:0; animation:reel-scroll var(--speed) linear infinite; }
  .reel-item{ height:calc(var(--h) - 20px); width:calc((var(--h) - 20px) * 16 / 9); border-radius:.75rem; overflow:hidden; position:relative; box-shadow:0 10px 24px rgba(0,0,0,.35); }
  .reel-item img{ width:100%; height:100%; object-fit:cover; transform-origin:center; animation:kenburns 16s ease-in-out infinite; }
  .reel-viewport:hover .reel-track{ animation-play-state:paused; }
  @keyframes reel-scroll{ 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
  @keyframes kenburns{ 0%{transform:scale(1)} 50%{transform:scale(1.08) translate(2%,-2%)} 100%{transform:scale(1)} }
  .glow-border{ position:relative; }
  .glow-border::before{ content:""; position:absolute; inset:-1px; border-radius:1.35rem; background:conic-gradient(from 0deg, rgba(99,102,241,.35), rgba(14,165,233,.35), rgba(236,72,153,.35), rgba(99,102,241,.35)); filter:blur(6px); opacity:.55; z-index:0; animation:spin 16s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg)} }

  /* ===== Activity ticker style ===== */
  .ticker{ overflow:hidden; white-space:nowrap; position:relative; }
  .ticker-track{ display:inline-block; padding-left:100%; animation:ticker-move 22s linear infinite; }
  .ticker:hover .ticker-track{ animation-play-state:paused; }
  @keyframes ticker-move{ to{ transform:translateX(-100%) } }

  /* Small “lift” hover for cards */
  .lift{ transition:transform .2s ease, box-shadow .2s ease }
  .lift:hover{ transform:translateY(-3px); box-shadow:0 20px 35px -12px rgba(0,0,0,.45) }

  /* ===== Attendance-themed scanner animation ===== */
  @keyframes card-move{
    0%{ transform:translateX(0) translateY(-50%); opacity:.0 }
    10%{ opacity:1 }
    45%{ transform:translateX(calc(100% + 7rem)) translateY(-50%) }
    55%{ transform:translateX(calc(100% + 7rem)) translateY(-50%) }
    90%{ opacity:1 }
    100%{ transform:translateX(0) translateY(-50%); opacity:.0 }
  }
  @keyframes beam-scan{
    0%{ transform:translateY(12%); opacity:.0 }
    10%{ opacity:.6 }
    50%{ transform:translateY(75%); opacity:.9 }
    90%{ opacity:.2 }
    100%{ transform:translateY(12%); opacity:.0 }
  }
  .animate-card{ animation:card-move 6.5s ease-in-out infinite }
  .animate-beam{ animation:beam-scan 2.8s ease-in-out infinite }

  @keyframes marquee{ 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
  .animate-marquee{ display:inline-block; min-width:200%; animation:marquee 18s linear infinite }
  #ticker:hover{ animation-play-state:paused }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- ===== HERO: Scanner + summary + live ticker (aligned with page padding) ===== -->
  <div class="glass rounded-2xl p-6 overflow-hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
      <!-- Scanner animation -->
      <div class="order-2 lg:order-1 lg:col-span-1">
        <div class="relative h-40 md:h-44 bg-slate-900/40 rounded-xl border border-white/10 overflow-hidden">
          <div class="absolute inset-y-0 left-0 w-2 bg-emerald-400/20"></div>
          <div class="absolute inset-y-0 right-0 w-2 bg-emerald-400/20"></div>

          <!-- Moving ID card -->
          <div class="idcard absolute top-1/2 -translate-y-1/2 -left-40 animate-card">
            <div class="h-24 w-40 md:h-28 md:w-48 rounded-lg bg-gradient-to-br from-slate-700 to-slate-800 shadow-xl ring-1 ring-white/10 p-3 flex gap-3">
              <div class="h-full aspect-square rounded-md bg-slate-600/70 grid place-items-center text-slate-300 text-xs">ID</div>
              <div class="flex-1">
                <div class="h-3 w-24 bg-slate-600/60 rounded mb-1"></div>
                <div class="h-2 w-20 bg-slate-600/40 rounded mb-3"></div>
                <div class="flex gap-1">
                  <div class="h-2 w-10 bg-emerald-500/60 rounded"></div>
                  <div class="h-2 w-6 bg-emerald-500/40 rounded"></div>
                  <div class="h-2 w-8 bg-emerald-500/30 rounded"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Scan beam -->
          <div class="absolute inset-0 pointer-events-none">
            <div class="beam h-1 w-full bg-emerald-400/40 blur-md animate-beam"></div>
          </div>

          <!-- Status -->
          <div class="absolute top-3 right-3 text-xs flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse"></span>
            <span class="text-slate-300">Scanner ready</span>
          </div>
        </div>
      </div>

      <!-- Title + summary -->
      <div class="order-1 lg:order-2 lg:col-span-2">
        <div class="flex items-center justify-between gap-4">
          <div>
            <h2 class="text-xl md:text-2xl font-semibold text-white">Today’s Attendance</h2>
            <p class="text-slate-400 text-sm">{{ today.strftime('%A, %B %d, %Y') }}</p>
          </div>
          <div class="hidden md:flex items-center gap-6">
            <div class="text-right">
              <div class="text-[11px] uppercase tracking-wider text-slate-400">Present</div>
              <div class="text-2xl font-semibold text-emerald-300">{{ metrics.present_today }}</div>
            </div>
            <div class="text-right">
              <div class="text-[11px] uppercase tracking-wider text-slate-400">Late</div>
              <div class="text-2xl font-semibold text-amber-300">{{ metrics.late_today }}</div>
            </div>
            <div class="text-right">
              <div class="text-[11px] uppercase tracking-wider text-slate-400">Absent</div>
              <div class="text-2xl font-semibold text-rose-300">{{ metrics.absent_today }}</div>
            </div>
          </div>
        </div>

        <!-- Live ticker (from engine) -->
        <div class="mt-4 rounded-lg border border-white/10 bg-slate-900/40 overflow-hidden">
          <div class="px-3 py-2 text-xs text-slate-400 border-b border-white/10 flex items-center gap-2">
            <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Recent Check-ins (live)
          </div>
          <div class="relative">
            <div id="ticker" class="whitespace-nowrap will-change-transform animate-marquee py-2">
              {% for emp in (metrics.late_employees or []) %}
                <span class="inline-flex items-center gap-2 px-4 text-sm text-slate-200">
                  <span class="h-2 w-2 rounded-full bg-amber-400"></span>
                  {{ emp.name }} • Late at {{ emp.time }}
                </span>
              {% endfor %}
            </div>
            <div class="pointer-events-none absolute inset-y-0 left-0 w-24 from-[#0b1220] to-transparent bg-gradient-to-r"></div>
            <div class="pointer-events-none absolute inset-y-0 right-0 w-24 from-transparent to-[#0b1220] bg-gradient-to-r"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Subtle status ticker -->
  <div class="glass rounded-xl px-4 py-2 ring-1 ring-white/10">
    <div class="flex items-center gap-3">
      <span class="text-xs px-2 py-0.5 rounded bg-emerald-500/15 text-emerald-300 ring-1 ring-emerald-500/25">Live</span>
      <div class="ticker text-sm text-slate-300 flex-1">
        <div id="tickerTrack" class="ticker-track">
          {% if metrics.ticker and metrics.ticker|length>0 %}
            {% for t in metrics.ticker %} • {{ t }} &nbsp;&nbsp;{% endfor %}
          {% else %}
            • System ready • Attendance sync OK • No alerts • Cameras idle • Tip: Press <b>Start Camera</b> to begin streaming •
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Header actions -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-white">Dashboard</h1>
      <p class="text-slate-400 mt-1">{{ today.strftime('%B %d, %Y') }}</p>
    </div>
    <div class="flex items-center gap-3">
      <a href="{{ url_for('attendance_page') }}" class="glass px-4 py-2 rounded-xl text-sky-300 hover:text-white">View Attendance</a>
      <a href="{{ url_for('export_daily') }}" class="lift px-4 py-2 rounded-xl bg-gradient-to-r from-sky-500 to-fuchsia-500 hover:to-fuchsia-400 text-white shadow-lg">Export Today</a>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="glass rounded-2xl p-6 lift">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-[11px] uppercase tracking-wider text-slate-400">Total Users</div>
          <div class="mt-2 text-3xl font-semibold text-white">{{ metrics.total_users }}</div>
        </div>
        <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-500 grid place-items-center">
          <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M7 20H2v-2a3 3 0 015.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </div>
      </div>
    </div>

    <div class="glass rounded-2xl p-6 lift">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-[11px] uppercase tracking-wider text-slate-400">Present Today</div>
          <div class="mt-2 flex items-end gap-2">
            <div class="text-3xl font-semibold text-emerald-300">{{ metrics.present_today }}</div>
            <span id="kpi-present-diff" class="text-[11px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300 hidden"></span>
          </div>
          <div class="text-[11px] text-slate-400 mt-1">{{ metrics.attendance_rate }}% attendance</div>
        </div>
        <div class="grid place-items-center">
          <canvas id="spark-present" width="90" height="40"></canvas>
        </div>
      </div>
    </div>

    <div class="glass rounded-2xl p-6 lift">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-[11px] uppercase tracking-wider text-slate-400">Absent Today</div>
          <div class="mt-2 text-3xl font-semibold text-rose-300">{{ metrics.absent_today }}</div>
        </div>
        <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-rose-500 to-orange-500 grid place-items-center">
          <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2 2-2m0 0l2 2m-2-2l-2 2M12 22a10 10 0 110-20 10 10 0 010 20z"/></svg>
        </div>
      </div>
    </div>

    <div class="glass rounded-2xl p-6 lift">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-[11px] uppercase tracking-wider text-slate-400">Late Today</div>
          <div class="mt-2 flex items-end gap-2">
            <div class="text-3xl font-semibold text-amber-300">{{ metrics.late_today }}</div>
            <span id="kpi-late-diff" class="text-[11px] px-2 py-0.5 rounded-full bg-amber-500/10 text-amber-300 hidden"></span>
          </div>
        </div>
        <div class="grid place-items-center">
          <canvas id="spark-late" width="90" height="40"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Camera (OFF by default—no stale frames) -->
  {% if enable_stream %}
  <div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-white flex items-center gap-2">
        <span id="live-dot" class="h-2 w-2 rounded-full bg-rose-500"></span>
        <span id="live-title">Camera (OFF)</span>
      </h2>
      <div class="flex items-center gap-2 text-xs text-slate-300">
        <button id="startBtn" class="glass px-3 py-1.5 rounded-lg">Start Camera</button>
        <button id="stopBtn"  class="glass px-3 py-1.5 rounded-lg opacity-50" disabled>Stop</button>
        <button id="refreshBtn" class="glass px-3 py-1.5 rounded-lg inline-flex items-center gap-2">
          <svg id="refreshSpin" class="w-4 h-4 hidden animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          <span>Refresh</span>
        </button>
        <button id="autoBtn" class="glass px-3 py-1.5 rounded-lg">Auto: ON</button>
      </div>
    </div>

    <div class="relative rounded-xl overflow-hidden bg-black min-h-[220px]">
      <div id="camOffOverlay" class="absolute inset-0 grid place-items-center bg-gradient-to-tr from-slate-900/80 to-slate-800/70 z-10">
        <div class="text-center">
          <div class="mx-auto mb-3 h-10 w-10 rounded-full grid place-items-center bg-white/10">
            <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 6h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2z"/></svg>
          </div>
          <p class="text-slate-200 font-medium">Camera is OFF</p>
          <p class="text-slate-400 text-xs mt-1">Click “Start Camera” to begin streaming.</p>
        </div>
      </div>

      <img id="liveImg" class="w-full h-auto hidden select-none" alt="Live Feed" loading="lazy" referrerpolicy="no-referrer" data-stream-url="{{ camera_stream_url or url_for('video_feed') }}">
      <div id="liveBadge" class="hidden absolute top-4 right-4 glass px-3 py-1 rounded-lg">
        <span class="text-green-400 text-sm font-medium">● LIVE</span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Late / Absent -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="glass rounded-2xl p-6">
      <h2 class="text-xl font-bold text-white mb-4">Late Arrivals Today</h2>
      {% if metrics.late_employees %}
      <div class="space-y-3">
        {% for emp in metrics.late_employees %}
        <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-3">
          <div class="flex justify-between items-center">
            <span class="text-white font-medium">{{ emp.name }}</span>
            <span class="text-amber-300 text-sm">{{ emp.time }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-slate-400 text-center py-8">No late arrivals today</p>
      {% endif %}
    </div>

    <div class="glass rounded-2xl p-6">
      <h2 class="text-xl font-bold text-white mb-4">Absent Today</h2>
      {% if metrics.absent_employees %}
      <div class="space-y-3">
        {% for emp in metrics.absent_employees %}
        <div class="bg-rose-500/10 border border-rose-500/20 rounded-lg p-3">
          <span class="text-white font-medium">{{ emp.name }}</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-slate-400 text-center py-8">Everyone is present!</p>
      {% endif %}
    </div>
  </div>

  <!-- Weekly Trend -->
  {% if metrics.weekly_labels %}
  <div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-white">Weekly Attendance Trend</h2>
      <p id="refresh-time" class="text-xs text-slate-400"></p>
    </div>
    <canvas id="weeklyChart" height="90"></canvas>
  </div>
  {% endif %}
</div>

<!-- Toast -->
<div id="scanToast" class="fixed top-24 right-4 z-50 hidden">
  <div class="glass rounded-lg shadow-2xl p-4 border-l-4 border-emerald-500 min-w-[280px]">
    <div class="flex items-start">
      <svg class="h-5 w-5 text-emerald-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
      <div class="ml-3">
        <p class="text-sm font-medium text-white" id="toastTitle">User Scanned In</p>
        <p class="text-sm text-slate-400 mt-1" id="toastMsg">Details…</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ===== Tiny sparkline helper ===== */
function sparkline(el, data, stroke='#10b981', fillTop='rgba(16,185,129,.35)'){
  if (!el) return;
  new Chart(el, {
    type:'line',
    data:{ labels:data.map((_,i)=>i), datasets:[{
      data, tension:.35, pointRadius:0, borderWidth:1.5, borderColor:stroke,
      fill:true, backgroundColor:(ctx)=>{ const g=ctx.chart.ctx.createLinearGradient(0,0,0,40); g.addColorStop(0,fillTop); g.addColorStop(1,'rgba(0,0,0,0)'); return g; }
    }]},
    options:{ responsive:false, plugins:{ legend:{display:false}, tooltip:{enabled:false} }, scales:{ x:{display:false}, y:{display:false} } }
  });
}
sparkline(document.getElementById('spark-present'), {{ metrics.spark_present|default([2,3,4,5,4,6,7])|tojson }}, '#10b981','rgba(16,185,129,.35)');
sparkline(document.getElementById('spark-late'   ), {{ metrics.spark_late|default([1,1,2,1,3,2,1])|tojson }}, '#f59e0b','rgba(245,158,11,.35)');

/* ===== Live ticker from /api/engine_status ===== */
(function(){
  const ticker = document.getElementById('ticker');
  const events = []; let lastKey='';
  function addItem(name, gate){
    const time = new Date().toLocaleTimeString();
    const span = document.createElement('span');
    span.className = "inline-flex items-center gap-2 px-4 text-sm text-slate-200";
    span.innerHTML = `<span class="h-2 w-2 rounded-full bg-emerald-400"></span> ${name} • Gate ${gate||'?'} • ${time}`;
    ticker.appendChild(span); events.push(span); if (events.length>30){ const old=events.shift(); old.remove(); }
  }
  async function poll(){
    try{
      const res=await fetch('/api/engine_status'); const d=await res.json();
      if (d?.ok && d.name){ const key=`${d.name}-${d.gate}-${d.ts}`; if (key!==lastKey){ lastKey=key; addItem(d.name, d.gate); } }
    }catch(e){}
  }
  setInterval(poll, 2000);
})();

/* ===== Toast + polling to surface check-ins ===== */
let auto = true, pollTimer=null, lastKeyToast='';
const autoBtn = document.getElementById('autoBtn');
const refreshBtn = document.getElementById('refreshBtn');
const refreshSpin = document.getElementById('refreshSpin');

function showToast(title,msg){
  const t=document.getElementById('scanToast');
  document.getElementById('toastTitle').textContent=title;
  document.getElementById('toastMsg').textContent=msg;
  t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 4500);
}
async function pollEngine(){
  try{
    const r=await fetch('/api/engine_status'); const d=await r.json();
    if (d?.ok && d.name){
      const key=`${d.name}-${d.gate}-${d.ts}`;
      if (key!==lastKeyToast){ lastKeyToast=key; showToast(`${d.name} checked in`, `Gate ${d.gate||'?'} • ${new Date().toLocaleTimeString()}`); setTimeout(tryUpdateCharts, 800); }
    }
  }catch(e){}
}
function toggleAuto(){
  auto=!auto; autoBtn.textContent=`Auto: ${auto?'ON':'OFF'}`;
  if (auto){ pollTimer=setInterval(pollEngine, 2000); autoBtn.classList.remove('opacity-50'); }
  else { clearInterval(pollTimer); autoBtn.classList.add('opacity-50'); }
}
autoBtn?.addEventListener('click', toggleAuto);
refreshBtn?.addEventListener('click', async()=>{ refreshSpin.classList.remove('hidden'); await pollEngine(); setTimeout(()=>refreshSpin.classList.add('hidden'), 400); });
pollTimer=setInterval(pollEngine, 2000);

/* ===== Weekly chart ===== */
{% if metrics.weekly_labels %}
const weeklyCtx=document.getElementById('weeklyChart').getContext('2d');
let weeklyChart=new Chart(weeklyCtx,{
  type:'line',
  data:{
    labels: {{ metrics.weekly_labels|tojson }},
    datasets:[
      { label:'Present', data: {{ metrics.weekly_present|tojson }}, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.12)', tension:.35, pointRadius:2 },
      { label:'Late',    data: {{ metrics.weekly_late|tojson }},    borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,.12)', tension:.35, pointRadius:2 }
    ]
  },
  options:{
    responsive:true, maintainAspectRatio:true,
    plugins:{ legend:{ labels:{ color:'#9ca3af' } }, decimation:{ enabled:true, algorithm:'lttb' } },
    scales:{ y:{ beginAtZero:true, ticks:{ color:'#9ca3af' }, grid:{ color:'rgba(255,255,255,.08)' } },
            x:{ ticks:{ color:'#9ca3af' }, grid:{ color:'rgba(255,255,255,.08)' } } }
});
function setRefreshTime(){ const el=document.getElementById('refresh-time'); if(el) el.textContent=`Last updated: ${new Date().toLocaleTimeString()}`; }
setRefreshTime();

async function tryUpdateCharts(){
  try{
    const r=await fetch('/api/charts_data'); const d=await r.json();
    if (d?.ok && weeklyChart){
      if (d.bar_data?.labels)  weeklyChart.data.labels=d.bar_data.labels;
      if (d.bar_data?.present) weeklyChart.data.datasets[0].data=d.bar_data.present;
      if (d.bar_data?.late)    weeklyChart.data.datasets[1].data=d.bar_data.late;
      weeklyChart.update(); setRefreshTime();
    }
  }catch(e){}
}
setInterval(tryUpdateCharts, 30000);
{% endif %}

/* ===== Camera control (OFF by default; busts cache) ===== */
const liveImg=document.getElementById('liveImg');
const offOverlay=document.getElementById('camOffOverlay');
const badge=document.getElementById('liveBadge');
const dot=document.getElementById('live-dot');
const titleEl=document.getElementById('live-title');
const startBtn=document.getElementById('startBtn');
const stopBtn=document.getElementById('stopBtn');

function startCamera(){
  if (!liveImg) return;
  const base=liveImg.dataset.streamUrl;
  const src=base+(base.includes('?')?'&':'?')+'v='+Date.now();
  liveImg.src=src;
  liveImg.classList.remove('hidden');
  offOverlay.classList.add('hidden');
  badge.classList.remove('hidden');
  dot.classList.remove('bg-rose-500'); dot.classList.add('bg-emerald-500');
  titleEl.textContent='Camera (LIVE)';
  startBtn.disabled=true; startBtn.classList.add('opacity-50');
  stopBtn.disabled=false; stopBtn.classList.remove('opacity-50');
}
function stopCamera(){
  if (!liveImg) return;
  liveImg.src=''; liveImg.classList.add('hidden');
  offOverlay.classList.remove('hidden');
  badge.classList.add('hidden');
  dot.classList.remove('bg-emerald-500'); dot.classList.add('bg-rose-500');
  titleEl.textContent='Camera (OFF)';
  startBtn.disabled=false; startBtn.classList.remove('opacity-50');
  stopBtn.disabled=true; stopBtn.classList.add('opacity-50');
}
stopCamera(); // ensure OFF on load
startBtn?.addEventListener('click', startCamera);
stopBtn ?.addEventListener('click', stopCamera);
</script>
{% endblock %}
