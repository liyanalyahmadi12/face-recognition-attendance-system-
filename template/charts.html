{% extends "base.html" %}
{% block title %}Analytics Charts{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-white">Analytics Charts</h1>
      <p class="text-slate-400 mt-1">Visual insights into attendance patterns</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-gradient-to-r from-sky-500 to-indigo-500 text-white shadow-lg hover:to-indigo-400">
        <span class="inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.5M4.5 9A7.5 7.5 0 1121 12"/></svg>
          Refresh
        </span>
      </button>
      <button id="autoToggle" class="glass px-4 py-2 rounded-xl text-slate-200 hover:bg-white/10">
        <span id="autoText">Auto: ON</span>
      </button>
    </div>
  </div>

  <!-- Top: Pie + Bar -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card p-6 card-hover">
      <h2 class="text-xl font-semibold mb-4">Today's Attendance Distribution</h2>
      <div class="h-72"><canvas id="pieChart"></canvas></div>
      <div class="grid grid-cols-3 gap-4 mt-6 text-center">
        <div>
          <div class="text-2xl font-bold text-emerald-300">{{ pie_data.values[0] }}</div>
          <div class="text-sm text-slate-400">On Time</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-amber-300">{{ pie_data.values[1] }}</div>
          <div class="text-sm text-slate-400">Late</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-rose-300">{{ pie_data.values[2] }}</div>
          <div class="text-sm text-slate-400">Absent</div>
        </div>
      </div>
    </div>

    <div class="card p-6 card-hover">
      <h2 class="text-xl font-semibold mb-4">7-Day Attendance Trend</h2>
      <div class="h-72"><canvas id="barChart"></canvas></div>
      <div class="flex justify-center gap-6 mt-3 text-sm text-slate-400">
        <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded" style="background:#60a5fa"></span> Present</div>
        <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded" style="background:#f59e0b"></span> Late</div>
      </div>
    </div>
  </div>

  <!-- Heatmap -->
  <div class="card p-6 card-hover">
    <h2 class="text-xl font-semibold mb-2">30-Day Attendance Heat Map</h2>
    <p class="text-slate-400 text-sm mb-4">Darker = higher attendance</p>

    <div class="grid grid-cols-7 gap-2 mb-2">
      {% for day in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
      <div class="text-center text-xs text-slate-400 font-semibold">{{ day }}</div>
      {% endfor %}
    </div>

    <div class="grid grid-cols-7 gap-2">
      {% for item in heatmap_data %}
        {% if loop.index0 == 0 %}
          {% set first_day_offset = item.weekday %}
          {% if first_day_offset == 'Sun' %}{% set offset = 0 %}
          {% elif first_day_offset == 'Mon' %}{% set offset = 1 %}
          {% elif first_day_offset == 'Tue' %}{% set offset = 2 %}
          {% elif first_day_offset == 'Wed' %}{% set offset = 3 %}
          {% elif first_day_offset == 'Thu' %}{% set offset = 4 %}
          {% elif first_day_offset == 'Fri' %}{% set offset = 5 %}
          {% else %}{% set offset = 6 %}{% endif %}
          {% for i in range(offset) %}
            <div></div>
          {% endfor %}
        {% endif %}

        {% if item.rate >= 80 %}{% set color = 'bg-emerald-500' %}
        {% elif item.rate >= 60 %}{% set color = 'bg-emerald-600' %}
        {% elif item.rate >= 40 %}{% set color = 'bg-amber-600' %}
        {% elif item.rate >= 20 %}{% set color = 'bg-orange-700' %}
        {% elif item.rate > 0 %}{% set color = 'bg-rose-700' %}
        {% else %}{% set color = 'bg-slate-800' %}{% endif %}

        <div class="aspect-square {{ color }} rounded grid place-items-center text-xs text-white/90 hover:ring-2 hover:ring-sky-400 transition"
             title="{{ item.date }}: {{ item.rate }}%">
          {{ item.day }}
        </div>
      {% endfor %}
    </div>

    <div class="flex items-center justify-center gap-2 mt-4 text-xs text-slate-400">
      <span>Less</span>
      <div class="flex gap-1">
        <span class="h-4 w-4 rounded bg-slate-800"></span>
        <span class="h-4 w-4 rounded bg-rose-700"></span>
        <span class="h-4 w-4 rounded bg-orange-700"></span>
        <span class="h-4 w-4 rounded bg-amber-600"></span>
        <span class="h-4 w-4 rounded bg-emerald-600"></span>
        <span class="h-4 w-4 rounded bg-emerald-500"></span>
      </div>
      <span>More</span>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="card p-4 text-center">
      <div class="text-slate-400 text-sm">Avg Daily Attendance</div>
      <div class="text-3xl font-bold text-sky-300 mt-1">
        {{ ((bar_data.present[0] + bar_data.present[1] + bar_data.present[2] + bar_data.present[3] + bar_data.present[4] + bar_data.present[5] + bar_data.present[6]) / 7)|round(1) }}
      </div>
    </div>
    <div class="card p-4 text-center">
      <div class="text-slate-400 text-sm">Total Late This Week</div>
      <div class="text-3xl font-bold text-amber-300 mt-1">
        {{ bar_data.late[0] + bar_data.late[1] + bar_data.late[2] + bar_data.late[3] + bar_data.late[4] + bar_data.late[5] + bar_data.late[6] }}
      </div>
    </div>
    <div class="card p-4 text-center">
      <div class="text-slate-400 text-sm">Peak Attendance Day</div>
      <div class="text-3xl font-bold text-emerald-300 mt-1">
        {% set max_val = bar_data.present[0] %}
        {% set max_idx = 0 %}
        {% for i in range(1, 7) %}
          {% if bar_data.present[i] > max_val %}{% set max_val = bar_data.present[i] %}{% set max_idx = i %}{% endif %}
        {% endfor %}
        {{ bar_data.labels[max_idx] }}
      </div>
    </div>
    <div class="card p-4 text-center">
      <div class="text-slate-400 text-sm">Tracking Period</div>
      <div class="text-3xl font-bold text-fuchsia-300 mt-1">{{ heatmap_data|length }}</div>
      <div class="text-xs text-slate-500">days</div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pieChart, barChart;
let autoRefreshEnabled = true;
let refreshInterval;

// Initialize charts
function initCharts(data) {
  // PIE
  const pieEl = document.getElementById('pieChart');
  if (!pieEl) return;
  const pieCtx = pieEl.getContext('2d');
  if (pieChart) pieChart.destroy();

  pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: data.pie_data.labels,
      datasets: [{
        data: data.pie_data.values,
        backgroundColor: data.pie_data.colors || ['#10b981','#f59e0b','#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#9ca3af', padding: 12, boxWidth: 14 }
        }
      },
      cutout: '60%'
    }
  });

  // BAR
  const barEl = document.getElementById('barChart');
  const barCtx = barEl.getContext('2d');
  if (barChart) barChart.destroy();

  barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: data.bar_data.labels,
      datasets: [
        {
          label: 'Present',
          data: data.bar_data.present,
          backgroundColor: '#60a5fa',
          borderRadius: 6
        },
        {
          label: 'Late',
          data: data.bar_data.late,
          backgroundColor: '#f59e0b',
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { color: 'rgba(255,255,255,.08)' }, ticks: { color: '#9ca3af' } },
        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,.08)' }, ticks: { color: '#9ca3af', stepSize: 1 } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

async function refreshData() {
  try {
    const res = await fetch('/api/charts_data');
    const data = await res.json();
    if (data.ok) initCharts(data);
  } catch (e) {
    console.error('Error refreshing charts:', e);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // initial data from server-rendered context
  const initialData = {
    pie_data: {{ pie_data|tojson }},
    bar_data: {{ bar_data|tojson }},
    heatmap_data: {{ heatmap_data|tojson }}
  };
  initCharts(initialData);

  // refresh button
  document.getElementById('refreshBtn')?.addEventListener('click', refreshData);

  // auto toggle
  const autoBtn = document.getElementById('autoToggle');
  const autoText = document.getElementById('autoText');
  autoBtn?.addEventListener('click', () => {
    autoRefreshEnabled = !autoRefreshEnabled;
    autoText.textContent = autoRefreshEnabled ? 'Auto: ON' : 'Auto: OFF';
    if (autoRefreshEnabled) {
      refreshInterval = setInterval(refreshData, 30000);
    } else {
      clearInterval(refreshInterval);
    }
  });

  // start auto-refresh
  refreshInterval = setInterval(refreshData, 30000);
});
</script>
{% endblock %}
